<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Message</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: dark;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at top, #1f2933 0, #0b1015 55%, #05070a 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", Roboto, sans-serif;
            color: #e5e7eb;
        }
        .chat-shell {
            width: 100%;
            max-width: 960px;
            height: 90vh;
            max-height: 640px;
            background: rgba(15, 23, 42, 0.92);
            border-radius: 18px;
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.6);
            display: grid;
            grid-template-columns: 260px 1fr;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        @media (max-width: 768px) {
            .chat-shell {
                grid-template-columns: 1fr;
                height: 100vh;
                max-height: none;
                border-radius: 0;
            }
        }
        .sidebar {
            background: linear-gradient(180deg, #020617 0%, #020617 35%, #020617 100%);
            border-right: 1px solid rgba(148, 163, 184, 0.25);
            padding: 18px 18px 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-title-icon {
            width: 26px;
            height: 26px;
            border-radius: 8px;
            background: radial-gradient(circle at 30% 0, #38bdf8 0, #0ea5e9 40%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0b1120;
            font-weight: 900;
            font-size: 0.9rem;
        }
        .sidebar-sub {
            font-size: 0.78rem;
            color: #9ca3af;
        }
        .status-pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #6b7280;
        }
        .status-pill.connected .status-dot {
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }
        .status-pill.connecting .status-dot {
            background: #eab308;
            box-shadow: 0 0 0 4px rgba(234, 179, 8, 0.25);
        }
        .status-pill.disconnected .status-dot {
            background: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.25);
        }
        .status-text {
            letter-spacing: 0.03em;
        }
        .card {
            background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.9));
            border-radius: 12px;
            padding: 12px 12px 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }
        .card-label {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: #9ca3af;
        }
        .input-row {
            display: flex;
            gap: 8px;
        }
        .input-text {
            flex: 1;
            min-width: 0;
            border-radius: 999px;
            border: 1px solid rgba(75, 85, 99, 0.9);
            padding: 7px 12px;
            font-size: 0.9rem;
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            outline: none;
        }
        .input-text::placeholder {
            color: #6b7280;
        }
        .btn {
            border-radius: 999px;
            border: none;
            padding: 7px 14px;
            font-size: 0.88rem;
            font-weight: 500;
            cursor: pointer;
            color: #0b1120;
            background: linear-gradient(135deg, #38bdf8, #0ea5e9, #2563eb);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }
        .btn-ghost {
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            border: 1px solid rgba(75, 85, 99, 0.8);
            box-shadow: none;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.78rem;
        }
        .help-text {
            margin-top: 4px;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .tips {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 6px;
            line-height: 1.5;
        }
        .tips span {
            color: #e5e7eb;
        }
        .main {
            padding: 18px 18px 16px 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .chat-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: #9ca3af;
        }
        .chat-title span {
            color: #e5e7eb;
        }
        .id-badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            border: 1px dashed rgba(148, 163, 184, 0.7);
            color: #cbd5f5;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .id-code {
            font-family: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
            letter-spacing: 0.08em;
        }
        .chat-window {
            flex: 1;
            min-height: 0;
            background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.16), rgba(15, 23, 42, 0.98));
            border-radius: 14px;
            border: 1px solid rgba(51, 65, 85, 0.9);
            padding: 10px 10px 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }
        .messages::-webkit-scrollbar {
            width: 6px;
        }
        .messages::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.8);
            border-radius: 999px;
        }
        .system-line {
            text-align: center;
            margin: 6px 0;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .system-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(30, 64, 175, 0.5);
            border: 1px solid rgba(59, 130, 246, 0.7);
        }
        .system-pill span {
            font-size: 0.7rem;
        }
        .msg-row {
            display: flex;
            margin-bottom: 4px;
        }
        .msg-row.me {
            justify-content: flex-end;
        }
        .msg-row.other {
            justify-content: flex-start;
        }
        .msg-bubble {
            max-width: 76%;
            padding: 7px 10px 6px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            word-break: break-word;
            position: relative;
        }
        .msg-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .msg-sender {
            font-weight: 500;
        }
        .msg-time {
            font-variant-numeric: tabular-nums;
        }
        .msg-row.me .msg-bubble {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-bottom-right-radius: 4px;
            color: #022c22;
        }
        .msg-row.other .msg-bubble {
            background: rgba(31, 41, 55, 0.95);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(75, 85, 99, 0.9);
            color: #e5e7eb;
        }
        .msg-row.me .msg-meta {
            color: rgba(15, 23, 42, 0.8);
        }
        .msg-row.other .msg-meta {
            color: #9ca3af;
        }
        .chat-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 4px;
            border-top: 1px solid rgba(51, 65, 85, 0.9);
        }
        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 72px;
            resize: none;
            border-radius: 999px;
            border: 1px solid rgba(75, 85, 99, 0.9);
            padding: 7px 12px;
            font-size: 0.9rem;
            background: rgba(15, 23, 42, 0.96);
            color: #e5e7eb;
            outline: none;
        }
        .chat-input::placeholder {
            color: #6b7280;
        }
        .send-btn {
            border-radius: 999px;
            border: none;
            padding: 7px 14px;
            font-size: 0.86rem;
            font-weight: 500;
            cursor: pointer;
            color: #e5e7eb;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 12px 24px rgba(129, 140, 248, 0.5);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .send-btn:disabled {
            opacity: 0.55;
            cursor: default;
            box-shadow: none;
        }
        .footer {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
        }
        .footer a {
            color: #9ca3af;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="chat-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div>
                    <div class="sidebar-title">
                        <div class="sidebar-title-icon">ğŸ“¶</div>
                        é€šè®¯
                    </div>
                    <div class="sidebar-sub">Instant Message</div>
                </div>
                <div id="status-pill" class="status-pill disconnected">
                    <span class="status-dot"></span>
                    <span class="status-text" id="status-text">æœªè¿æ¥</span>
                </div>
            </div>

            <div class="card">
                <div class="card-label">Channel</div>
                <div class="input-row">
                    <input id="room-input" class="input-text" type="text" maxlength="12" placeholder="ä¾‹å¦‚ 123456">
                    <button id="btn-join" class="btn">è¿æ¥</button>
                </div>
                <div class="help-text">
                    ä»»æ„è¾“å…¥ä¸€ä¸ªæ•°å­—/çŸ­è¯­ï¼Œä¸¤ç«¯è¾“å…¥ä¸€è‡´å³å¯è¿›å…¥åŒä¸€Channelã€‚
                </div>
            </div>

            <!-- <div class="card">
                <div class="card-label">è¿æ¥è¯´æ˜</div>
                <div class="tips">
                    <div>1. æ‰“å¼€æœ¬é¡µé¢ Aï¼Œåœ¨ä¸Šé¢è¾“å…¥Channelå¹¶ç‚¹å‡» <span>è¿æ¥</span>ã€‚</div>
                    <div>2. åœ¨å¦ä¸€å°è®¾å¤‡ B ä¸Šä¹Ÿæ‰“å¼€æœ¬é¡µé¢ï¼Œè¾“å…¥ç›¸åŒæˆ¿é—´å·å¹¶è¿æ¥ã€‚</div>
                    <div>3. å…¶ä¸­ä¸€ç«¯ä¼šè‡ªåŠ¨æˆä¸ºã€Œæˆ¿ä¸»ã€ï¼Œå¦ä¸€ç«¯è‡ªåŠ¨åŠ å…¥ï¼Œéšåå³å¯äº’ç›¸èŠå¤©ã€‚</div>
                </div>
            </div> -->

            <div class="card">
                <div class="card-label">Info</div>
                <div class="help-text">Connection ID</div>
                <div class="id-badge">
                    <span>Status:</span>
                    <span id="my-id" class="id-code">å°šæœªè¿æ¥</span>
                </div>
                <!-- <div class="help-text" style="margin-top:6px;">å¯¹æ–¹è¿æ¥åˆ°åŒä¸€æˆ¿é—´åï¼Œæœ¬é¡µé¢ä¸ä¼šç»è¿‡ä»»ä½•é¢å¤–æœåŠ¡å™¨ä¸­è½¬èŠå¤©å†…å®¹ã€‚</div> -->
            </div>

            <!-- <div class="footer">
                ä½¿ç”¨ <a href="https://peerjs.com" target="_blank" rel="noopener noreferrer">PeerJS å…¬å…±ä¿¡ä»¤æœåŠ¡</a>
            </div> -->
        </aside>

        <main class="main">
            <div class="chat-header">
                <div class="chat-title">
                    Channelï¼š<span id="current-room">æœªé€‰æ‹©</span>
                </div>
                <button id="btn-leave" class="btn btn-ghost btn-sm" disabled>æ–­å¼€è¿æ¥</button>
            </div>

            <section class="chat-window">
                <div id="messages" class="messages">
                    <div class="system-line">
                        <span class="system-pill">
                            <span>ğŸ‘‹</span>
                            <span>è¾“å…¥Channelå¹¶ç‚¹å‡»ã€Œè¿æ¥ã€ï¼Œå¼€å§‹é€šè®¯</span>
                        </span>
                    </div>
                </div>
                <div class="chat-input-row">
                    <textarea id="chat-input" class="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ" disabled></textarea>
                    <button id="btn-send" class="send-btn" disabled>
                        <span>å‘é€</span>
                        <span>â®</span>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let conn = null;
        let currentRoom = null;
        let isHost = false;

        const roomInput = document.getElementById('room-input');
        const btnJoin = document.getElementById('btn-join');
        const btnLeave = document.getElementById('btn-leave');
        const messagesEl = document.getElementById('messages');
        const chatInput = document.getElementById('chat-input');
        const btnSend = document.getElementById('btn-send');
        const myIdEl = document.getElementById('my-id');
        const currentRoomEl = document.getElementById('current-room');
        const statusPill = document.getElementById('status-pill');
        const statusText = document.getElementById('status-text');

        function setStatus(state, text) {
            statusPill.classList.remove('connected', 'connecting', 'disconnected');
            statusPill.classList.add(state);
            statusText.textContent = text;
        }

        function appendSystem(text) {
            const line = document.createElement('div');
            line.className = 'system-line';
            line.innerHTML = '<span class="system-pill"><span>â„¹ï¸</span><span>' + text + '</span></span>';
            messagesEl.appendChild(line);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function appendMessage(fromMe, text) {
            const row = document.createElement('div');
            row.className = 'msg-row ' + (fromMe ? 'me' : 'other');

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';

            const meta = document.createElement('div');
            meta.className = 'msg-meta';

            const sender = document.createElement('span');
            sender.className = 'msg-sender';
            sender.textContent = fromMe ? 'æˆ‘' : 'å¯¹æ–¹';

            const time = document.createElement('span');
            time.className = 'msg-time';
            const now = new Date();
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            time.textContent = hh + ':' + mm;

            meta.appendChild(sender);
            meta.appendChild(time);

            const body = document.createElement('div');
            body.textContent = text;

            bubble.appendChild(meta);
            bubble.appendChild(body);
            row.appendChild(bubble);
            messagesEl.appendChild(row);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function cleanRoomId(raw) {
            return raw.trim().replace(/\s+/g, '-').slice(0, 20);
        }

        function enableChat(enabled) {
            chatInput.disabled = !enabled;
            btnSend.disabled = !enabled;
            btnLeave.disabled = !enabled;
            if (enabled) {
                chatInput.focus();
            }
        }

        function resetConnection() {
            if (conn) {
                try { conn.close(); } catch (e) {}
                conn = null;
            }
            if (peer) {
                try { peer.destroy(); } catch (e) {}
                peer = null;
            }
            currentRoom = null;
            isHost = false;
            myIdEl.textContent = 'å°šæœªè¿æ¥';
            currentRoomEl.textContent = 'æœªé€‰æ‹©';
            enableChat(false);
            setStatus('disconnected', 'æœªè¿æ¥');
        }

        function joinRoom(rawRoom) {
            const cleaned = cleanRoomId(rawRoom);
            if (!cleaned) {
                roomInput.focus();
                return;
            }
            resetConnection();

            currentRoom = cleaned;
            currentRoomEl.textContent = cleaned;
            appendSystem('æ­£åœ¨åŠ å…¥æˆ¿é—´ã€Œ' + cleaned + 'ã€...');
            setStatus('connecting', 'è¿æ¥ä¸­...');
            btnJoin.disabled = true;

            const roomPeerId = 'chat-room-' + cleaned;

            isHost = true;
            peer = new Peer(roomPeerId);

            peer.on('open', id => {
                myIdEl.textContent = id;
                setStatus('connecting', 'å·²åˆ›å»ºé€šé“ï¼Œç­‰å¾…å¯¹æ–¹åŠ å…¥...');
                appendSystem('é€šé“å·²åˆ›å»ºï¼Œåœ¨å¦ä¸€è®¾å¤‡è¾“å…¥ç›¸åŒChannelå³å¯åŠ å…¥ã€‚');
            });

            peer.on('connection', c => {
                if (conn && conn.open) {
                    c.close();
                    return;
                }
                conn = c;
                setupConnection();
            });

            peer.on('error', err => {
                if (err.type === 'unavailable-id') {
                    appendSystem('æ£€æµ‹åˆ°Channelå·²å­˜åœ¨ï¼Œå°è¯•ä½œä¸ºåŠ å…¥æ–¹è¿æ¥...');
                    becomeGuest(roomPeerId);
                } else {
                    appendSystem('è¿æ¥å‡ºé”™ï¼š' + err.type);
                    setStatus('disconnected', 'æœªè¿æ¥');
                    btnJoin.disabled = false;
                }
            });
        }

        function becomeGuest(roomPeerId) {
            isHost = false;
            if (peer) {
                try { peer.destroy(); } catch (e) {}
            }
            peer = new Peer();

            peer.on('open', id => {
                myIdEl.textContent = id;
                appendSystem('ä½œä¸ºåŠ å…¥æ–¹ï¼Œæ­£åœ¨è¿æ¥...');
                setStatus('connecting', 'è¿æ¥ä¸­...');
                conn = peer.connect(roomPeerId);
                setupConnection();
            });

            peer.on('error', err => {
                appendSystem('è¿æ¥å‡ºé”™ï¼š' + err.type);
                setStatus('disconnected', 'æœªè¿æ¥');
                btnJoin.disabled = false;
            });
        }

        function setupConnection() {
            if (!conn) return;

            conn.on('open', () => {
                appendSystem('å·²ä¸å¯¹æ–¹å»ºç«‹è¿æ¥ï¼Œç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©ã€‚');
                setStatus('connected', 'å·²è¿æ¥');
                enableChat(true);
                btnJoin.disabled = false;
            });

            conn.on('data', data => {
                if (!data) return;
                if (data.type === 'chat' && typeof data.text === 'string') {
                    appendMessage(false, data.text);
                }
            });

            conn.on('close', () => {
                appendSystem('å¯¹æ–¹å·²æ–­å¼€è¿æ¥ã€‚');
                setStatus('disconnected', 'å·²æ–­å¼€');
                enableChat(false);
            });
        }

        function sendCurrentMessage() {
            const text = chatInput.value.replace(/\r\n/g, '\n').trim();
            if (!text) return;
            if (!conn || !conn.open) {
                appendSystem('å½“å‰æœªè¿æ¥åˆ°å¯¹æ–¹ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚');
                return;
            }
            chatInput.value = '';
            appendMessage(true, text);
            try {
                conn.send({ type: 'chat', text });
            } catch (e) {
                appendSystem('æ¶ˆæ¯å‘é€å¤±è´¥ã€‚');
            }
        }

        btnJoin.addEventListener('click', () => {
            joinRoom(roomInput.value);
        });

        roomInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                btnJoin.click();
            }
        });

        btnLeave.addEventListener('click', () => {
            if (!peer && !conn) return;
            appendSystem('ä½ å·²æ‰‹åŠ¨æ–­å¼€è¿æ¥ã€‚');
            resetConnection();
            btnJoin.disabled = false;
        });

        btnSend.addEventListener('click', () => {
            sendCurrentMessage();
        });

        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendCurrentMessage();
            }
        });

        window.addEventListener('beforeunload', () => {
            resetConnection();
        });

        (function initFromUrl() {
            try {
                const p = new URLSearchParams(window.location.search);
                const rid = p.get('room') || '';
                if (rid) {
                    roomInput.value = rid;
                    joinRoom(rid);
                }
            } catch (e) {}
        })();
    </script>
</body>
</html>

