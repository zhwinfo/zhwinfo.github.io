<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Timer Control</title>
  <style>
    body{background:#121212;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;overflow:hidden;font-family:"Segoe UI","Microsoft YaHei",sans-serif}
    #top{flex:1;display:flex;justify-content:center;align-items:center;color:#00FF88;font-weight:bold;font-family:"黑体",SimHei,sans-serif;line-height:1}
    #timer-text{display:inline-block;white-space:nowrap;font-size:18vw}
    #timer-text .digit{font-family:'Courier New',Courier,monospace;font-variant-numeric:tabular-nums}
    #timer-text .colon{font-family:"Segoe UI","Microsoft YaHei",sans-serif;letter-spacing:-0.02em}
    #bottom{display:flex;flex-direction:column;align-items:center;padding:16px}
    #local-time{font-size:8vh;color:#FFFFFF;margin-bottom:12px}
    #controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;color:#fff}
    #connect{display:flex;flex-direction:column;gap:8px;color:#fff;width:100%;max-width:1000px;margin-top:8px}
    #connect input[type="text"]{width:100%;box-sizing:border-box}
    input{background:#fff;border:none;font-size:1.2rem;padding:6px 8px;width:130px;text-align:center}
    button{background:#1F1F1F;color:#fff;border:none;padding:10px 18px;font-size:1.1rem;font-weight:bold;cursor:pointer;transition:background .2s}
    button:hover{background:#2E2E2E}
  </style>
</head>
<body>
  <div id="top"><span id="timer-text">--:--:--</span></div>
  <div id="bottom">
    <div id="local-time">00:00:00</div>
    <div id="controls">
      <span>设定时间(HH:MM:SS)</span>
      <input id="time-input" type="text" value="00:10:00">
      <button id="btn-set">设定</button>
      <button id="btn-start">开始</button>
      <button id="btn-pause">暂停</button>
      <button id="btn-reset">重置</button>
      <button id="btn-toggle-connect">跨设备</button>
      <input id="room-id" type="text" placeholder="房间号" style="width:120px">
      <button id="btn-auto-connect">自动连接</button>
      <button id="btn-qr-share">分享二维码</button>
      <span id="status" style="color:#FF6666;margin-left:8px"></span>
    </div>
    <div id="connect" style="display: none;">
      <div style="font-size:1.1rem">跨设备连接 <span id="connection-status" style="font-weight:normal;padding-left:10px;"></span></div>
      <div id="auto-link" style="font-size:0.95rem;color:#ccc"></div>
      <canvas id="qr-canvas" style="display:none;margin-top:6px;width:160px;height:160px"></canvas>
      <button id="btn-gen-offer">生成 Offer</button>
      <input type="text" id="offer-output" placeholder="复制此 Offer 到被控页" readonly>
      <div>粘贴被控页生成的 Answer</div>
      <input type="text" id="answer-input" placeholder="在此粘贴 Answer">
      <button id="btn-accept-answer">连接</button>
    </div>
  </div>
  <script>
    let bc = null;
    let running = false;
    let remaining = 0;
    let pc=null, dc=null, pcIceDone=false, pendingCandidates=[];
    const timerText=document.getElementById('timer-text');
    const localTimeLabel=document.getElementById('local-time');
    const timeInput=document.getElementById('time-input');
    const btnSet=document.getElementById('btn-set');
    const btnStart=document.getElementById('btn-start');
    const btnPause=document.getElementById('btn-pause');
    const btnReset=document.getElementById('btn-reset');
    const status=document.getElementById('status');
    const btnGenOffer=document.getElementById('btn-gen-offer');
    const offerOutput=document.getElementById('offer-output');
    const answerInput=document.getElementById('answer-input');
    const btnAcceptAnswer=document.getElementById('btn-accept-answer');
    const connectionStatus=document.getElementById('connection-status');
    const roomInput=document.getElementById('room-id');
    const btnAutoConnect=document.getElementById('btn-auto-connect');
    const autoLink=document.getElementById('auto-link');
    const btnQRShare=document.getElementById('btn-qr-share');
    const qrCanvas=document.getElementById('qr-canvas');

    function setConnectionStatus(text, color) {
        connectionStatus.textContent = text;
        connectionStatus.style.color = color;
    }

    function updateLocalTime(){
      const now=new Date();
      const h=String(now.getHours()).padStart(2,'0');
      const m=String(now.getMinutes()).padStart(2,'0');
      const s=String(now.getSeconds()).padStart(2,'0');
      localTimeLabel.textContent=h+':'+m+':'+s;
    }
    function render(hms){
      timerText.innerHTML=hms.replace(/:/g,"<span class='colon'>:</span>").replace(/\d/g,d=>"<span class='digit'>"+d+"</span>");
    }
    function formatSeconds(total){
      const t=Math.max(total,0);
      const h=Math.floor(t/3600);
      const m=Math.floor((t%3600)/60);
      const s=t%60;
      return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }
    function parseHMS(text){
      const parts=text.trim().split(':');
      if(parts.length!==3) return null;
      const h=parseInt(parts[0],10), m=parseInt(parts[1],10), s=parseInt(parts[2],10);
      if([h,m,s].some(isNaN)) return null;
      if(m<0||m>=60||s<0||s>=60||h<0||h>99) return null;
      return h*3600+m*60+s;
    }
    function send(cmd,value){
      if(bc) bc.postMessage({type:'command',cmd:cmd,value:value});
      if(dc && dc.readyState==='open'){
        try{dc.send(JSON.stringify({type:'command',cmd:cmd,value:value}))}catch(e){}
      }
    }

    function init(){
      try{bc=new BroadcastChannel('timer-sync');}catch(e){bc=null}
      if(bc){
        bc.onmessage=function(ev){
          const msg=ev.data;
          if(!msg||typeof msg!=='object') return;
          if(msg.type==='status'){
            running=!!msg.running;
            remaining=msg.remaining||0;
            render(formatSeconds(remaining));
            status.textContent=running?'计时中':'已暂停';
          }
        };
      }
      updateLocalTime();
      setInterval(updateLocalTime,1000);
      render('--:--:--');
      btnSet.addEventListener('click',()=>{
        const secs=parseHMS(timeInput.value);
        if(secs==null){status.textContent='时间格式错误';return}
        send('set',secs);
      });
      btnStart.addEventListener('click',()=>send('start'));
      btnPause.addEventListener('click',()=>send('pause'));
      btnReset.addEventListener('click',()=>send('reset'));
      btnGenOffer.addEventListener('click',genOffer);
      btnAcceptAnswer.addEventListener('click',acceptAnswer);
      document.getElementById('btn-toggle-connect').addEventListener('click', () => {
        const connectDiv = document.getElementById('connect');
        connectDiv.style.display = connectDiv.style.display === 'none' ? 'flex' : 'none';
      });
      // 默认房间号
      if(!roomInput.value){
        roomInput.value = Math.random().toString().slice(2,8);
      }
      updateAutoLink();
      btnAutoConnect.addEventListener('click', autoConnectControl);
      btnQRShare.addEventListener('click', showQR);
    }
    function signalBase(){
      const host = window.location.hostname;
      return `http://${host}:5001`;
    }
    function updateAutoLink(){
      const rid = roomInput.value.trim();
      if(!rid){ autoLink.textContent=''; qrCanvas.style.display='none'; return; }
      const url = `${window.location.origin}/Timer/index.html?room=${encodeURIComponent(rid)}`;
      autoLink.innerHTML = `被控页快捷链接：<a href="${url}" target="_blank" style="color:#66ccff">${url}</a>`;
      // 绘制二维码
      drawQR(url);
    }
    function drawQR(text){
      const ctx = qrCanvas.getContext('2d');
      const size = 160;
      qrCanvas.width = size;
      qrCanvas.height = size;
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,size,size);
      ctx.fillStyle = '#000';
      const qr = genQR(text);
      const cell = size / qr.length;
      for(let y=0;y<qr.length;y++){
        for(let x=0;x<qr[y].length;x++){
          if(qr[y][x]) ctx.fillRect(x*cell, y*cell, cell, cell);
        }
      }
      qrCanvas.style.display='block';
    }
    function genQR(text){
      // 简易二维码生成（21x21 模式1）
      const size = 21;
      const qr = Array.from({length:size},()=>Array(size).fill(0));
      // 定位点
      function placeFinder(x,y){
        for(let dy=0;dy<7;dy++){
          for(let dx=0;dx<7;dx++){
            qr[y+dy][x+dx] = (dx===0||dy===0||dx===6||dy===6||(dx>=2&&dx<=4&&dy>=2&&dy<=4))?1:0;
          }
        }
      }
      placeFinder(0,0); placeFinder(14,0); placeFinder(0,14);
      // 简单数据填充（仅支持数字+字母，示例）
      const data = text.split('').map(c=>c.charCodeAt(0));
      let idx = 0;
      for(let y=0;y<size&&idx<data.length*8;y+=2){
        for(let x=size-1;x>=0&&idx<data.length*8;x--){
          if(qr[y][x]===0 && (x>8||y>8)){
            qr[y][x] = (data[Math.floor(idx/8)] >> (7-idx%8)) & 1;
            idx++;
          }
        }
      }
      return qr;
    }
    function showQR(){
      if(qrCanvas.style.display==='none'){
        updateAutoLink();
      } else {
        qrCanvas.style.display='none';
      }
    }
    roomInput && roomInput.addEventListener('input', updateAutoLink);
    async function postJSON(path, body){
      const res = await fetch(`${signalBase()}${path}?room=${encodeURIComponent(roomInput.value.trim())}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body||{})
      });
      if(!res.ok) throw new Error('network');
      return res.json().catch(()=>({}));
    }
    function subscribeEvents(handler){
      const rid = roomInput.value.trim();
      let stopped = false;
      const poll = async () => {
        if (stopped) return;
        try{
          const res = await fetch(`${signalBase()}/poll?room=${encodeURIComponent(rid)}&type=answer`, {cache:'no-store'});
          if(res.ok){
            const json = await res.json().catch(()=>({}));
            if(json && !json.empty){
              handler('answer', json);
              stopped = true;
              return;
            }
          }
        }catch(_){}
        setTimeout(poll, 1500);
      };
      poll();
      return { stop(){ stopped = true; } };
    }
    async function autoConnectControl(){
      const rid = roomInput.value.trim();
      if(!rid) { status.textContent='请填写房间号'; return; }
      setConnectionStatus('正在生成 Offer...', '#888');
      pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      pc.oniceconnectionstatechange = e => {
          switch(pc.iceConnectionState) {
              case "connecting": setConnectionStatus("连接中...", "#66ccff"); break;
              case "connected": setConnectionStatus("已连接", "#00FF88"); break;
              case "failed": setConnectionStatus("连接失败", "#FF6666"); break;
              case "disconnected": setConnectionStatus("连接断开", "#FF6666"); break;
              case "closed": setConnectionStatus("连接关闭", "#888"); break;
              default: setConnectionStatus(pc.iceConnectionState, "#888"); break;
          }
      };
      dc=pc.createDataChannel('timer');
      dc.onopen=function(){};
      dc.onmessage=function(ev){
        try{
          const msg=JSON.parse(ev.data);
          if(msg.type==='status'){
            running=!!msg.running;
            remaining=msg.remaining||0;
            render(formatSeconds(remaining));
            status.textContent=running?'计时中':'已暂停';
          }
        }catch(e){}
      };
      subscribeEvents(async (type, payload)=>{
        if(type==='answer' && pc && !pc.currentRemoteDescription){
          try{
            await pc.setRemoteDescription(payload);
          }catch(e){}
        }
      });
      pc.onicecandidate = async function(ev){
        if(!ev.candidate){
          try{
            await postJSON('/offer', pc.localDescription);
            setConnectionStatus('Offer 已发布，等待 Answer', '#888');
          }catch(e){
            setConnectionStatus('信令服务器不可用', '#FF6666');
          }
        }
      };
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
    }
    // 纯前端连接：将 Offer 编码到 URL 并通过二维码分享，被控端扫码后回传 Answer（手动粘贴一次 Answer 即可）
    async function genOffer(){
      setConnectionStatus('正在生成 Offer...', '#888');
      pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      
      pc.oniceconnectionstatechange = e => {
          switch(pc.iceConnectionState) {
              case "connecting": setConnectionStatus("连接中...", "#66ccff"); break;
              case "connected": setConnectionStatus("已连接", "#00FF88"); break;
              case "failed": setConnectionStatus("连接失败", "#FF6666"); break;
              case "disconnected": setConnectionStatus("连接断开", "#FF6666"); break;
              case "closed": setConnectionStatus("连接关闭", "#888"); break;
              default: setConnectionStatus(pc.iceConnectionState, "#888"); break;
          }
      };

      dc=pc.createDataChannel('timer');
      dc.onopen=function(){};
      dc.onmessage=function(ev){
        try{
          const msg=JSON.parse(ev.data);
          if(msg.type==='status'){
            running=!!msg.running;
            remaining=msg.remaining||0;
            render(formatSeconds(remaining));
            status.textContent=running?'计时中':'已暂停';
          }
        }catch(e){}
      };
      pc.onicecandidate=function(ev){
        if(!ev.candidate){
            offerOutput.value=JSON.stringify(pc.localDescription);
            setConnectionStatus('Offer 已生成，请复制或扫码分享', '#888');
            // 将 Offer 编码到 URL 方便扫码
            const encoded = encodeURIComponent(btoa(JSON.stringify(pc.localDescription)));
            const shareUrl = `${window.location.origin}/Timer/index.html?offer=${encoded}`;
            updateAutoLink();
            drawQR(shareUrl);
        }
      };
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
    }
    async function genOffer(){
      setConnectionStatus('正在生成 Offer...', '#888');
      pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      
      pc.oniceconnectionstatechange = e => {
          switch(pc.iceConnectionState) {
              case "connecting": setConnectionStatus("连接中...", "#66ccff"); break;
              case "connected": setConnectionStatus("已连接", "#00FF88"); break;
              case "failed": setConnectionStatus("连接失败", "#FF6666"); break;
              case "disconnected": setConnectionStatus("连接断开", "#FF6666"); break;
              case "closed": setConnectionStatus("连接关闭", "#888"); break;
              default: setConnectionStatus(pc.iceConnectionState, "#888"); break;
          }
      };

      dc=pc.createDataChannel('timer');
      dc.onopen=function(){
          // This is another way to confirm connection
      };
      dc.onmessage=function(ev){
        try{
          const msg=JSON.parse(ev.data);
          if(msg.type==='status'){
            running=!!msg.running;
            remaining=msg.remaining||0;
            render(formatSeconds(remaining));
            status.textContent=running?'计时中':'已暂停';
          }
        }catch(e){}
      };
      pc.onicecandidate=function(ev){
        if(!ev.candidate){
            offerOutput.value=JSON.stringify(pc.localDescription);
            setConnectionStatus('Offer 已生成，待连接', '#888');
        }
      };
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
    }
    async function acceptAnswer(){
      if(!pc) return;
      const text=answerInput.value.trim();
      if(!text) return;
      try {
        const ans=JSON.parse(text);
        await pc.setRemoteDescription(ans);
      } catch(e) {
        setConnectionStatus('Answer 无效', '#FF6666');
      }
    }
    init();
    // 若 URL 携带 Answer，自动填充并连接
    const urlParams = new URLSearchParams(window.location.search);
    const encodedAnswer = urlParams.get('answer') || '';
    if (encodedAnswer) {
        try {
            const answer = JSON.parse(atob(decodeURIComponent(encodedAnswer)));
            answerInput.value = JSON.stringify(answer);
            setTimeout(() => {
                acceptAnswer();
            }, 0);
        } catch(e){
            status.textContent = 'URL Answer 解析失败';
        }
    }
  </script>
</body>
</html>
